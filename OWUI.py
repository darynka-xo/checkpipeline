import logging
import sys
import asyncio
from typing import List, Union, Generator, Iterator
from pydantic import BaseModel
from llama_index.core import VectorStoreIndex, Document, set_global_handler

set_global_handler("simple")
logging.basicConfig(stream=sys.stdout, level=logging.DEBUG)
logging.getLogger().addHandler(logging.StreamHandler(stream=sys.stdout))


class Pipeline:
    class Valves(BaseModel):
        TOP_K: int = 3
        MAX_DOC_SIZE: int = 1000
        MODEL_ID: str = "gpt-4o"
        TEMPERATURE: float = 0.5
        MAX_TOKENS: int = 1500

    def __init__(self):
        self.name = "Debate Pipeline"
        self.valves = self.Valves()
        self.index = None

    async def on_startup(self):
        logging.info("Pipeline is warming up...")

        # Create and insert documents into the index
        doc1 = Document(text="""
        Глава 1. Общие положения

1. Настоящие Правила и условия проведения предвыборных дебатов разработаны в соответствии с пунктом 3 статьи 28 Конституционного закона Республики Казахстан "О выборах в Республике Казахстан" (далее - Конституционный закон) и определяют порядок и условия проведения предвыборных дебатов (далее - дебаты) кандидатов в Президенты, политических партий, выдвинувших партийные списки кандидатов в депутаты Мажилиса и (или) маслихатов Республики Казахстан, кандидатов в депутаты Сената Парламента, кандидатов по одномандатным территориальным избирательным округам в депутаты Мажилиса и маслихатов, кандидатов в акимы.

2. Кандидаты в Президенты, политические партии, выдвинувшие партийные списки кандидатов в депутаты Мажилиса Парламента, вправе участвовать в предвыборных дебатах, организуемых Центральной избирательной комиссией (далее – Центризбирком).

3. Политические партии, выдвинувшие партийные списки кандидатов в депутаты маслихатов, кандидаты в депутаты Сената Парламента, а также кандидаты по одномандатным территориальным избирательным округам в депутаты Мажилиса Парламента и маслихатов, кандидаты в акимы могут участвовать в предвыборных дебатах, которые вправе согласно пункту 3 статьи 28 Конституционного закона организовывать соответствующие территориальные избирательные комиссии.

Глава 2. Условия проведения предвыборных дебатов

4. Центризбирком в течение пяти календарных дней с момента принятия решения о проведении дебатов определяет формат и письменно уведомляет кандидатов в Президенты Республики Казахстан, политические партии, выдвинувшие партийные списки кандидатов в депутаты Мажилиса о дате, времени и месте проведения дебатов.

5. Территориальная избирательная комиссия в течение пяти календарных дней с момента принятия решения о проведении дебатов определяет формат и письменно уведомляет о дате, времени и месте проведения дебатов политические партии, выдвинувшие:

1) партийные списки кандидатов в депутаты маслихатов;

2) кандидатов по одномандатным территориальным избирательным округам в депутаты маслихатов;

3) кандидатов в акимы.

6. Центризбирком для территориальных избирательных комиссий в течение трех календарных дней с момента принятия решения о проведении дебатов среди кандидатов по одномандатным территориальным избирательным округам в депутаты Мажилиса Парламента, кандидатов в депутаты Сената Парламента определяет общий единый формат проведения дебатов и уведомляет их.

Территориальные избирательные комиссии в течение двух календарных дней с момента получения от Центризбирком формата проведения дебатов для кандидатов по одномандатным территориальным избирательным округам в депутаты Мажилиса Парламента, кандидатов в депутаты Сената Парламента письменно уведомляют о дате, времени, месте формате проведения дебатов политические партии.

7. При формате проведения дебатов на телевидении, телеканалы предоставляют свое эфирное время на телевидении зарегистрированным кандидатам в Президенты Республики Казахстан, в акимы, кандидатам в депутаты Мажилиса и (или) маслихата, выдвинутым по партийным спискам политических партий, кандидатам по одномандатным территориальным избирательным округам в депутаты Мажилиса Парламента и маслихатов, кандидатам в депутаты Сената Парламента, для дебатов на договорной основе с Центризбиркомом или соответствующей избирательной комиссией с указанием даты, времени, места и регламента проведения дебатов.

8. Телеканалы в соответствии с договором резервируют эфирное время для проведения дебатов кандидатами в Президенты Республики Казахстан, в акимы, в депутаты Мажилиса и (или) маслихатов, от политических партий, выдвинувших партийные списки, кандидатами по одномандатным территориальным избирательным округам в депутаты Мажилиса Парламента и маслихатов, кандидатами в депутаты Сената Парламента. Объем эфирного времени для выступлений кандидатов должен быть одинаковым.

9. Список участников, присутствующих лиц во время дебатов на телевидении утверждается Центризбиркомом или соответствующей территориальной избирательной комиссией.

10. Избирательные комиссии совместно с местными исполнительными органами и органами местного самоуправления определяют помещения для проведения дебатов.

Помещения должны быть оборудованы аудио и видеоустройствами для трансляции теле-, радиопрограмм, а также подключены к сети Интернет (при его наличии) для проведения онлайн-трансляции дебатов.

11. Избирательные комиссии определяют ведущего для проведения публичных дебатов.

12. Избирательные комиссии проводят освещение через средства массовой информации о проводимых дебатах.

Глава 3. Порядок проведения предвыборных дебатов

13. Очередность выступления кандидатов устанавливается по жребию.

14. Ведущий обеспечивает соблюдение регламента проведения дебатов, согласованного с Центризбиркомом или соответствующей территориальной избирательной комиссией.

15. Ведущий дебатов:

не нарушает регламент проведения предвыборных дебатов в кандидатов;

контролирует время выступления кандидатов в Президенты в акимы, в депутаты Мажилиса и (или) маслихатов от политических партий, выдвинувших партийные списки кандидатов, кандидатов по одномандатным территориальным избирательным округам в депутаты Мажилиса Парламента и маслихатов, кандидатов в депутаты Сената Парламента, если иное не предусмотрено регламентом их проведения, либо если это не обусловлено окончанием времени;

не отдает предпочтение кому-либо из кандидатов, политических партий и не комментирует их выступления.

16. Кандидаты в Президенты, в акимы, депутаты Мажилиса и (или) маслихатов, выдвинутые политическими партиями, кандидаты по одномандатным территориальным избирательным округам в депутаты Мажилиса Парламента и маслихатов, кандидатами в депутаты Сената Парламента:

соблюдают регламент проведения дебатов;

ведут дискуссию в рамках этических норм, воздерживаются и не допускают оскорбительных, заведомо ложных, унижающих честь и достоинство высказываний в адрес других кандидатов, политических партий, их членов, а также дискриминации по отношению к представителям других политических партий;

не допускают пропаганды и агитации насильственного изменения конституционного строя, нарушения целостности Республики Казахстан, подрыва безопасности государства, разжигания социальной, расовой, национальной, религиозной, сословной и родовой розни, культа жестокости и насилия, а также создания не предусмотренных законодательством военизированных формирований;

выполняют обоснованные требования ведущего.

17. Во время дебатов кандидатам в Президенты, в акимы, кандидатам в депутаты Мажилиса и (или) маслихатов, выдвинутым политическими партиями, кандидатам по одномандатным территориальным избирательным округам в депутаты Мажилиса Парламента и маслихатов, кандидатам в депутаты Сената Парламента, а также иным присутствующим лицам не допускается прерывать выступления кандидатов, а также сопровождать их какими-либо комментариями.

18. Кандидаты в Президенты, в акимы, политические партии, выдвинувшие партийные списки кандидатов в депутаты Мажилиса и (или) маслихатов, кандидаты по одномандатным территориальным избирательным округам в депутаты Мажилиса Парламента и маслихатов, кандидаты в депутаты Сената Парламента могут отказаться от участия в дебатах.

19. В случае неучастия кандидатов в Президенты, в акимы, политических партий, выдвинувших партийные списки кандидатов в депутаты Мажилиса и (или) маслихатов, кандидатов по одномандатным территориальным избирательным округам в депутаты Мажилиса Парламента и маслихатов, кандидатов в депутаты Сената Парламента, время на дебатах, предназначенное для данного кандидата, партии, распределяется поровну между другими участниками дебатов.

20. Язык проведения дебатов: казахский и русский.

21. Записи дебатов кандидатов в Президенты, в акимы, политических партий, выдвинувших партийные списки кандидатов в депутаты Мажилиса и (или) маслихатов, кандидатов по одномандатным территориальным избирательным округам в депутаты Мажилиса Парламента и маслихатов, кандидатов в депутаты Сената Парламента в соответствии с пунктом 2 статьи 16 Закона Республики Казахстан "О средствах массовой информации" хранятся не менее шести месяцев с момента последней записи на телеканалах.""")

        self.index = VectorStoreIndex([])
        self.index.insert(doc1)

        logging.info("Documents inserted into the index")

    async def on_shutdown(self):
        logging.info("Pipeline is shutting down...")

    async def make_request_with_retry(self, fn, retries=3, *args, **kwargs):
        for attempt in range(retries):
            try:
                return await fn(*args, **kwargs)
            except Exception as e:
                logging.error(f"Attempt {attempt + 1} failed: {e}")
                if attempt + 1 == retries:
                    raise
                await asyncio.sleep(2 ** attempt)

    def pipe(
        self, user_message: str, model_id: str, messages: List[dict], body: dict
    ) -> Union[str, Generator, Iterator]:

        if not self.index:
            return "Pipeline not initialized."


        system_message = """
**Роль**: Вы - профессиональный аналитик дебатов, специализирующийся на глубоком и беспристрастном разборе аргументов с точки зрения нормативных актов Казахстана.

**Цель анализа**:
1. Провести всестороннюю экспертизу предоставленного аргумента
2. Оценить логическую структуру и соответствие нормативным требованиям
3. Выявить потенциальные слабости и предложить конкретные улучшения

**Требования к анализу**:

#### 1. Раздел "Аналитическая записка"
- Полный структурированный разбор аргумента
- Оценка логической связности и аргументированности
- Выявление скрытых посылок и неявных допущений
- Определение уровня доказательности каждого тезиса

#### 2. Раздел "Отчет о соответствии нормативным актам"
- Детальная проверка каждого утверждения на соответствие официальным нормам
- Точные ссылки на конкретные статьи и пункты нормативных документов
- Квалификация обнаруженных отклонений (minor/significant)
- Правовая оценка потенциальных нарушений

#### 3. Раздел "Рекомендации по улучшению"
- Конкретные предложения по доработке аргументации
- Методические рекомендации по усилению слабых позиций
- Альтернативные формулировки и подходы
- Стратегические советы для повышения убедительности
"""

        # Step 4: Format user message
        user_prompt = (
            system_message
            + "\n\nКонтекст и Аргумент на анализ:\n" + user_message
        )
        logging.info(f"Querying index with: {user_prompt}")
        query_engine = self.index.as_query_engine()
        response = query_engine.query(user_prompt)
        return response.response_gen